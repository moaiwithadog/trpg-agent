# TRPG Agent 設計書

## 1. 概要

### 1.1 目的

TRPG Agent は以下の目的で開発されたシステムです：

- **TRPGルールブックのテストプレイ自動化**: ルールの破綻や曖昧さを検出する
- **LLMのTRPG能力の検証**: 異なるLLMのGM能力・PL能力を比較評価する
- **物語の自動生成**: TRPGの枠組みを活用したLLMによる物語の自動生成

### 1.2 設計方針

1. **シンプルさ**: 最小限のコードで動作する構成
2. **柔軟性**: GM/PLのモデルを自由に切り替え可能
3. **可観測性**: ログを詳細に記録し、後から分析可能
4. **人間の介入**: ターン毎にが随時介入できるポイントを設ける

### 1.3 全体構成図

```
┌─────────────────────────────────────────────────────┐
│                  オーケストレーター（人間）            │
│                    - 監視・介入                      │
└─────────────────┬───────────────────┬───────────────┘
                  │                   │
                  ▼                   ▼
┌─────────────────────────┐   ┌─────────────────────────┐
│        GM役LLM          │   │        PL役LLM          │
│  (Claude / ChatGPT)     │   │  (Claude / ChatGPT)     │
│                         │   │                         │
│  - 状況描写             │   │  - 行動宣言             │
│  - 判定・裁定           │   │  - PCのロールプレイ     │
│  - NPC操作              │   │                         │
│  - 行動候補提示         │   │                         │
└────────────┬────────────┘   └────────────┬────────────┘
             │                             │
             │     コンテキスト非共有       │
             │    （独立したセッション）    │
             │                             │
             └──────────┬──────────────────┘
                        │
                        ▼
              ┌─────────────────┐
              │  orchestrator   │
              │  - 進行管理     │
              │  - 異常検知     │
              │  - ログ保存     │
              └─────────────────┘
```

---

## 2. 概念定義

### 2.1 ターン / セッション / キャンペーン

| 概念 | 定義 | 終了条件 |
|------|------|----------|
| **ターン** | GMの出力とPLの入力の1往復 | 1回の往復で終了 |
| **セッション** | 複数ターンで構成 | GMが【セッション終了】を出力 / 最大ターン到達 |
| **キャンペーン** | 複数セッションで構成 | 人間による終了判断 |

### 2.2 GM / PL / オーケストレーター

| 役割 | 担当 | 責務 |
|------|------|------|
| **GM（ゲームマスター）** | LLM | 状況描写、判定・裁定、NPC操作、行動候補提示 |
| **PL（プレイヤー）** | LLM | PCの行動宣言、ロールプレイ |
| **オーケストレーター** | 人間 | 監視、介入、シナリオ承認、継続判断 |

---

## 3. アーキテクチャ

### 3.1 ファイル構成

```
trpg-agent/
├── .env                 # APIキー（Git管理外）
├── .gitignore           # Git除外設定
├── config.py            # 設定管理
├── agents.py            # LLM呼び出し
├── orchestrator.py      # ゲーム進行管理
├── main.py              # エントリポイント
├── rulebook.md          # TRPGルールブック
├── scenarios/
│   └── template_fantasy.md  # シナリオテンプレート
└── logs/
    └── campaign_*.md    # セッションログ
```

### 3.2 モジュール間の依存関係

```
main.py
    │
    └── orchestrator.py
            │
            ├── agents.py
            │       │
            │       └── config.py
            │
            └── config.py
```

### 3.3 データフロー

```
[シナリオテンプレート] ──→ [PLシナリオ生成] ──→ [GM初期描写]
                                                    │
                                                    ▼
                              ┌─────────────────────────────┐
                              │         ターンループ         │
                              │                             │
                              │  GM描写 → PL行動 → GM裁定   │
                              │      ↑               │      │
                              │      └───────────────┘      │
                              └─────────────────────────────┘
                                                    │
                                                    ▼
                              [セッション終了] → [PL次回フック選択]
                                                    │
                                                    ▼
                              [継続?] ─→ YES → [次セッション]
                                  │
                                  └─→ NO → [キャンペーン終了]
```

---

## 4. モジュール詳細

### 4.1 config.py

設定値を一元管理するモジュール。

**主な設定項目：**

| 変数名 | 型 | 説明 |
|--------|-----|------|
| `GM_PROVIDER` | str | GMのLLMプロバイダー（"anthropic" / "openai"） |
| `GM_MODEL` | str | GMのモデル名 |
| `PL_PROVIDER` | str | PLのLLMプロバイダー |
| `PL_MODEL` | str | PLのモデル名 |
| `MAX_TURNS` | int | 1セッションの最大ターン数 |

### 4.2 agents.py

LLM呼び出しを抽象化するモジュール。

**主な関数：**

| 関数名 | 説明 |
|--------|------|
| `call_llm()` | 汎用LLM呼び出し（プロバイダーを抽象化） |
| `call_gm()` | GM役LLMを呼び出す |
| `call_pl()` | PL役LLMを呼び出す |
| `call_pl_scenario_gen()` | PLにシナリオ生成を依頼 |
| `call_pl_next_hook()` | PLに次回フック選択を依頼 |
| `load_file()` | ファイル読み込みユーティリティ |

**システムプロンプト：**

- `GM_SYSTEM_PROMPT`: ルールブックを含むGM用プロンプト
- `PL_SYSTEM_PROMPT`: ルールブックを含むPL用プロンプト
- `PL_SCENARIO_GEN_PROMPT`: シナリオ生成用プロンプト
- `PL_NEXT_HOOK_PROMPT`: 次回フック選択用プロンプト

### 4.3 orchestrator.py

ゲーム進行を管理するモジュール。

**主なクラス：**

| クラス名 | 説明 |
|----------|------|
| `CampaignLogger` | ログをMarkdown形式で保存 |

**主な関数：**

| 関数名 | 説明 |
|--------|------|
| `check_pl_response()` | PL応答の異常検知 |
| `run_session()` | キャンペーン全体の進行管理 |

### 4.4 main.py

エントリポイント。シナリオテンプレートのパスを指定して `run_session()` を呼び出す。

---

## 5. 機能仕様

### 5.1 ゲーム進行フロー

```
1. キャンペーン開始
2. PLによるシナリオ生成
3. 人間によるシナリオ承認（Enter / r: 再生成 / q: 終了）
4. セッション開始
5. ターンループ
   5.1. GM描写
   5.2. PL行動宣言
   5.3. 異常検知（必要に応じて再試行）
   5.4. 人間の介入ポイント（Enter / q / 指示）
   5.5. 【セッション終了】検出でループ脱出
6. PLによる次回フック選択
7. 人間による継続判断（Enter / q / 指示）
8. 継続ならステップ4へ、終了ならキャンペーン終了
```

### 5.2 シナリオ生成

1. シナリオテンプレート（`scenarios/*.md`）を読み込む
2. PLにテンプレートを渡し、PC設定と初回セッション設定を生成させる
3. 人間が承認/再生成/中止を選択
4. 承認されたシナリオでセッション開始

### 5.3 異常検知

**PL応答の異常検知パターン：**

| パターン | 判定 |
|----------|------|
| 【行動宣言】が含まれない | 異常 |
| `Turn:`, `HP:`, `SP:` 等GM用語を含む | 異常（GM役割侵害） |
| `行動候補`, `あなたはどうしますか` 等を含む | 異常（GM役割侵害） |

**異常検知時の動作：**
1. 警告を表示
2. PLに再試行を依頼
3. 再試行結果を使用

### 5.4 ログ保存

**ファイル名形式：** `campaign_YYYYMMDD_HHMMSS.md`

**記録内容：**
- キャンペーン情報（日時、GM/PLモデル）
- シナリオテンプレート
- PLによるシナリオ生成結果
- 各セッションの全ターン（GM/PL応答）
- 異常検知・再試行
- 人間の介入
- セッション/キャンペーン終了情報

---

## 6. データ構造

### 6.1 会話履歴

GM/PLそれぞれ独立した履歴を保持。

```python
gm_history = [
    {"role": "user", "content": "シナリオ設定..."},
    {"role": "assistant", "content": "GM描写..."},
    {"role": "user", "content": "PLの行動..."},
    ...
]

pl_history = [
    {"role": "user", "content": "GMからの描写..."},
    {"role": "assistant", "content": "PL行動宣言..."},
    ...
]
```

### 6.2 ログフォーマット

```markdown
# Campaign Log

## キャンペーン情報
- 開始日時: YYYY-MM-DD HH:MM:SS
- GM: provider / model
- PL: provider / model

## シナリオテンプレート
（テンプレート内容）

## PLによるシナリオ生成
（PL生成内容）

---

# Session 1

## Turn 0
### 【GM】
（GM出力）

## Turn 1
### 【PL】
（PL出力）

### 【GM】
（GM出力）

...

## セッション終了
- 終了理由: GM判断
- セッションターン数: N

---

# Campaign End
- 終了理由: 人間による終了
- 総セッション数: N
- 総ターン数: N
```

---

## 7. 外部インターフェース

### 7.1 LLM API

**Anthropic API（Claude）:**
- エンドポイント: `messages.create()`
- システムプロンプト: `system` パラメータで指定
- 会話履歴: `messages` パラメータで指定

**OpenAI API（ChatGPT）:**
- エンドポイント: `chat.completions.create()`
- システムプロンプト: `messages` の先頭に `role: system` で指定
- 会話履歴: `messages` パラメータで指定

### 7.2 ファイル入出力

| ファイル | 読み書き | 形式 |
|----------|----------|------|
| `.env` | 読み込み | KEY=VALUE |
| `rulebook.md` | 読み込み | Markdown |
| `scenarios/*.md` | 読み込み | Markdown |
| `logs/*.md` | 書き込み | Markdown |

---

## 8. 設定・カスタマイズ

### 8.1 GM/PLモデル変更

`config.py` を編集：

```python
# パターン1: Claude GM + ChatGPT PL
GM_PROVIDER = "anthropic"
GM_MODEL = "claude-sonnet-4-20250514"
PL_PROVIDER = "openai"
PL_MODEL = "gpt-4o-mini"

# パターン2: ChatGPT GM + Claude PL
GM_PROVIDER = "openai"
GM_MODEL = "gpt-4o"
PL_PROVIDER = "anthropic"
PL_MODEL = "claude-haiku-4-5-20251001"
```

### 8.2 シナリオテンプレート追加

`scenarios/` フォルダに新しいMarkdownファイルを作成：

```markdown
# シナリオテンプレート

## 舞台
（舞台設定）

## 大目的
（キャンペーン全体の目的）

## 世界設定
（世界観の説明）

## PLへの指示
（PLに生成させる内容の指示）
```

`main.py` でパスを変更：

```python
SCENARIO_TEMPLATE_PATH = "scenarios/your_template.md"
```

### 8.3 ルールブック変更

`rulebook.md` を直接編集。変更は次回起動時に反映される。

**注意点：**
- 出力フォーマットを変更する場合、`orchestrator.py` の異常検知パターンも更新が必要
- 【セッション終了】の形式を変更する場合、終了判定ロジックも更新が必要

---

## 9. バージョン履歴

| バージョン | 内容 |
|-----------|------|
| v1  | 基本動作版（GM: Claude Haiku, PL: ChatGPT） |
| v2  | GMをClaude Sonnetに変更（品質安定化） |
| v3  | Markdownログ保存機能追加 |
| v4  | 複数セッション対応（キャンペーン機能） |
| v5  | PLによるシナリオ生成・次回フック選択、ルールブック外部化 |
| v6  | GM/PLプロバイダー切り替え機能 |
| v61 | GPT5をオプションとして追加,関連する微調整 |
| v7  | docs: README.mdとDESIGN.mdを追加 |
| v71 | GM/PLの心得を追記,シナリオテンプレートファイルを追加,ほか微調整 |
